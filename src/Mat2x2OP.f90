MODULE MAT2x2OP
INTEGER,PARAMETER :: DP=8
INTERFACE MULTI_MATOP
  MODULE PROCEDURE MULTI_MATOP2
  MODULE PROCEDURE MULTI_MATOP3
  MODULE PROCEDURE MULTI_MATOP4
  MODULE PROCEDURE MULTI_MATOP5
END INTERFACE
CONTAINS

FUNCTION SUBMATOP(A,B)
IMPLICIT NONE
REAL(DP) :: A(4),B(4),SUBMATOP(4)
SUBMATOP(1) = A(1) * B(1) + A(2) * B(3)
SUBMATOP(3) = A(3) * B(1) + A(4) * B(3)
SUBMATOP(2) = A(1) * B(2) + A(2) * B(4)
SUBMATOP(4) = A(3) * B(2) + A(4) * B(4) 
END FUNCTION

FUNCTION SUBMATVECOP(A,B)
IMPLICIT NONE
REAL(DP) :: A(4),B(2),SUBMATVECOP(2)
SUBMATVECOP(1) = A(1) * B(1) + A(2) * B(2)
SUBMATVECOP(2) = A(3) * B(1) + A(4) * B(2)
END FUNCTION

FUNCTION MATINV(A)
IMPLICIT NONE
REAL (DP) :: A(4),MATINV(4),DET
DET = 1._DP/(A(1)*A(4) - A(2)*A(3))
MATINV(1) = A(4)
MATINV(3) = -A(3)
MATINV(2) = -A(2)
MATINV(4) = A(1) 
MATINV = DET * MATINV 
END FUNCTION

FUNCTION MATVECPRODUCT(A,B,N)
IMPLICIT NONE
INTEGER :: N
REAL(DP) :: A(4,-1:1,N),B(2,0:N+1),MATVECPRODUCT(2,N)
REAL(DP) :: LMNT(2)
INTEGER :: I,J
DO I = 1,N
LMNT = 0._DP
DO J=-1,1,1
  LMNT = LMNT + SUBMATVECOP(A(:,J,I),B(:,I+J))
ENDDO
MATVECPRODUCT(:,I) = LMNT
ENDDO
END FUNCTION

FUNCTION DOTPRODUCT(A,B,N)
IMPLICIT NONE
REAL(DP),INTENT(IN) :: A(N), B(N)
INTEGER :: N, I
REAL(DP) :: DOTPRODUCT
DOTPRODUCT = 0
DO I=1,N
  DOTPRODUCT = DOTPRODUCT+ A(I)*B(I)
ENDDO
END FUNCTION

SUBROUTINE DIR4X4(A,B,X)
IMPLICIT NONE
! SOLVE A 4X4 LINEAR SYSTEM BY GAUSS ELIMINATION
! A IS TRANSFERRED AS A ONE-D ARRAYR, NUMBERED LEFT-TO-RIGHT THEN TOP TO BOTTOM
REAL(DP) :: A(16),B(4),X(4)
REAL(DP) M1,M2,M3,M4,C22,C23,C24,C32,C33,C34,C42,C43,C44
REAL(DP) :: D2,D3,D4
!A=RESHAPE(AHAT(:,:),(/16/))
!CALL CONVERT_MAT2VEC(AHAT,A)
C22=A(6)
C23=A(7)
C24=A(8)
C32=A(10)
C33=A(11)
C34=A(12)
C42=A(14)
C43=A(15)
C44=A(16)
D2=B(2)
D3=B(3)
D4=B(4)
M1=1/A(1)
M2=M1*A(5)
M3=M1*A(9)
M4=M1*A(13)
C22=C22-A(2)*M2
C23=C23-A(3)*M2
C24=C24-A(4)*M2
D2=D2-B(1)*M2
C32=C32-A(2)*M3
C33=C33-A(3)*M3
C34=C34-A(4)*M3
D3=D3-B(1)*M3
C42=C42-A(2)*M4
C43=C43-A(3)*M4
C44=C44-A(4)*M4
D4=D4-B(1)*M4
M2=1/C22
M3=M2*C32
M4=M2*C42
C33=C33-C23*M3
C34=C34-C24*M3
D3=D3-D2*M3
C43=C43-C23*M4
C44=C44-C24*M4
D4=D4-D2*M4
M4=C43/C33
C44=C44-C34*M4
D4=D4-D3*M4
X(4)=D4/C44
X(3)=(D3-C34*X(4))/C33
X(2)=(D2-C23*X(3)-C24*X(4))/C22
X(1)=(B(1)-A(2)*X(2)-A(3)*X(3)-A(4)*X(4))/A(1)
END SUBROUTINE

SUBROUTINE CONVERT_MAT2VEC(AHAT,A)
IMPLICIT NONE
REAL(DP) AHAT(4,4), A(16)
INTEGER :: I,J,K
K=0
DO J=1,4
  DO I=1,4
    K=K+1
    A(K)=AHAT(J,I)
  ENDDO
ENDDO
END SUBROUTINE

FUNCTION MULTI_MATOP2(A1,A2)
IMPLICIT NONE
REAL(DP) :: A1(4),A2(4)
REAL(DP) :: MULTI_MATOP2(4)
MULTI_MATOP2 = 0._DP
MULTI_MATOP2 = SUBMATOP(A1,A2)
END FUNCTION

FUNCTION MULTI_MATOP3(A1,A2,A3)
IMPLICIT NONE
REAL(DP) :: A1(4),A2(4),A3(4)
REAL(DP) :: MULTI_MATOP3(4),TEMP(4)
MULTI_MATOP3 = 0._DP
TEMP = SUBMATOP(A2,A3)
MULTI_MATOP3 = SUBMATOP(A1,TEMP)
END FUNCTION

FUNCTION MULTI_MATOP4(A1,A2,A3,A4)
IMPLICIT NONE
REAL(DP) :: A1(4),A2(4),A3(4),A4(4)
REAL(DP) :: MULTI_MATOP4(4),TEMP1(4),TEMP2(4)
MULTI_MATOP4 = 0._DP
TEMP1 = SUBMATOP(A3,A4)
TEMP2 = SUBMATOP(A2,TEMP1)
MULTI_MATOP4 = SUBMATOP(A1,TEMP2)
END FUNCTION

FUNCTION MULTI_MATOP5(A1,A2,A3,A4,A5)
IMPLICIT NONE
REAL(DP) :: A1(4),A2(4),A3(4),A4(4),A5(4)
REAL(DP) :: MULTI_MATOP5(4),TEMP1(4),TEMP2(4)
MULTI_MATOP5 = 0._DP
TEMP1 = SUBMATOP(A4,A5)
TEMP2 = SUBMATOP(A3,TEMP1)
TEMP1 = SUBMATOP(A2,TEMP2)
MULTI_MATOP5 = SUBMATOP(A1,TEMP1)
END FUNCTION

SUBROUTINE SET_EIGS(MAT,LAMBDA,EIGVEC)
IMPLICIT NONE 
REAL(DP) :: MAT(4),LAMBDA(2),EIGVEC(4)
REAL(DP) :: MAT2(4),A,B,C,D
REAL(DP) :: TEMPORAL
EQUIVALENCE(MAT2(1),A)
EQUIVALENCE(MAT2(2),B)
EQUIVALENCE(MAT2(3),C)
EQUIVALENCE(MAT2(4),D)

MAT2 = MAT
TEMPORAL = SQRT(A*A+4._DP*B*C-2._DP*A*D+D*D)
LAMBDA(1) = 0.5_DP*(A+D-TEMPORAL)
LAMBDA(2) = 0.5_DP*(A+D+TEMPORAL)
EIGVEC(1)=-0.5_DP*(-A+D+TEMPORAL)/C; EIGVEC(3)=1;
EIGVEC(2)= 0.5_DP*(A-D+TEMPORAL)/C; EIGVEC(4)=1;

END SUBROUTINE      
END MODULE